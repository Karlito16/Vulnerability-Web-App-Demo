import express from 'express';
import { pool } from '../db/db';
import { configureHost } from '../utils/utils';

export const router: express.Router = express.Router();

let username: string | undefined = undefined;
let password: string | undefined = undefined;
let enableSQLInjection: boolean = true;
let enableCSRF: boolean = true;
let messages: string[] = [];
let passwordChanged: boolean = false;
let initialSearch: boolean = true;

const { externalUrl, port, host, baseUrl } = configureHost();
let url: string = externalUrl ?? baseUrl;
url = url.startsWith("https://") ? url : "https://" + url;

router.get('/', async(req, res) => {
    res.render('home', {
        username: username,
        usernameTemp: undefined,
        password: password,
        loginMessage: undefined,
        messages: messages,
        enableSQLInjection: enableSQLInjection,
        enableCSRF: enableCSRF,
        passwordChanged: passwordChanged,
        url: url,
        initialSearch
    });
});


router.post('/', async(req, res) => {
    const message: string = req.body.message;

    let query: string = 'SELECT id FROM users WHERE username = $1;';
    let queryArgs: string[] = [username ?? ""];
    pool.query(
        query,
        queryArgs,
        (error, results) => {
            if (error) res.redirect('/');
            const id = results.rows[0]["id"];
            query = 'INSERT INTO messages (message, author_id) VALUES ($1, $2);';
            queryArgs = [message, id];
            pool.query(
                query, 
                queryArgs, 
                (error, results) => {
                    res.redirect('/');
                }
            );
        }
    );
});


router.get('/search-messages', async(req, res) => {
    if (!username) {
        // login
        res.end();
    }
    enableSQLInjection = req.query["enable-sql-injection"] ? true : false;
    const searchValue: string = String(req.query["search-value"]);

    let query: string;
    let queryArgs: any[] = [];
    if (enableSQLInjection) {
        query = `SELECT username, message FROM messages JOIN users ON messages.author_id = users.id WHERE username = '${username}' AND message LIKE '%${searchValue}%';`;
    } else {
        query = "SELECT username, message FROM messages JOIN users ON messages.author_id = users.id WHERE username = $1 AND message LIKE $2;";
        queryArgs = [username, '%' + searchValue + '%'];
    }
    pool.query(
        query,
        queryArgs,
        (error, results) => {
            messages = results.rows;
            initialSearch = false;
            res.redirect('/');
        }
    );
});


router.post('/login', async(req, res) => {
    const usernameBody: string = req.body.username;
    const passwordBody: string = req.body.password;
    let query: string = 'INSERT INTO users (username, password) VALUES ($1, $2);';
    let queryArgs: string[] = [usernameBody, passwordBody];
    pool.query(
        query, 
        queryArgs, 
        (error, results) => {
            let loginMessage: string | undefined = undefined;
            if (error) {
                query = 'SELECT COUNT(*) FROM users WHERE username = $1 AND password = $2;';
                queryArgs = [usernameBody, passwordBody];
                pool.query(
                    query,
                    queryArgs,
                    (error, results) => {
                        if (results.rows[0]["count"] == "0") {
                            loginMessage = 'Username or password incorrect.';
                        } else {
                            username = usernameBody;
                            password = passwordBody;
                        }
                        res.render('home', {
                            username: username,
                            usernameTemp: usernameBody,
                            password: password,
                            loginMessage: loginMessage,
                            messages: messages,
                            enableSQLInjection: enableSQLInjection,
                            enableCSRF: enableCSRF,
                            passwordChanged: passwordChanged,
                            url: url,
                            initialSearch
                        });
                    }
                );
            } else {
                username = usernameBody;
                password = passwordBody;
                res.render('home', {
                    username: username,
                    usernameTemp: undefined,
                    password: password,
                    loginMessage: loginMessage,
                    messages: messages,
                    enableSQLInjection: enableSQLInjection,
                    enableCSRF: enableCSRF,
                    passwordChanged: passwordChanged,
                    url: url,
                    initialSearch
                });
            }
        }
    );
});


router.post("/csrf", (req, res) => {
    enableCSRF = !enableCSRF;
    res.redirect("/");
});


// Malicious web site, instead of having separated service, this endpoint simulates malicious web site (attacker)
router.get('/change-password', async(req, res) => {
    const usernameQuery: string = String(req.query["username"]);
    const passwordQuery: string = String(req.query["password"]);

    const query: string = 'UPDATE users SET password = $1 WHERE username = $2;';
    const queryArgs: string[] = [passwordQuery, usernameQuery];

    pool.query(
        query,
        queryArgs,
        (error, results) => {
            if (error) res.end();
            
            if (enableCSRF) {
                // If we don't stop the simulation, we will end up in infinity http-get request loop
                passwordChanged = false;
            }
            password = passwordQuery;
            res.redirect('/');
        }
    );
});


router.post('/change-password', async(req, res) => {
    const passwordBody: string = req.body.password;

    const query: string = 'UPDATE users SET password = $1 WHERE username = $2;';
    const queryArgs: string[] = [passwordBody, username ?? ""];

    pool.query(
        query,
        queryArgs,
        (error, results) => {
            if (error) res.end();
            
            if (enableCSRF) {
                // This will simulate pressing an unsecured url link for changing the password
                passwordChanged = true;
            }
            
            password = passwordBody;
            res.redirect('/');
        }
    );
});


router.get('/logout', async(req, res) => {
    username = undefined;
    password = undefined;
    initialSearch = true;
    messages = [];
    res.redirect('/');
});


router.get('/about', async(req, res) => {
   res.render('about', {
       username: username,
   }) 
});